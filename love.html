<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gift love ‚ù§Ô∏è</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./style/style.css">
</head>
<body>
  <canvas id="heartCanvas"></canvas>
  <!-- Resume audio from previous page if available -->
  <audio id="audio" src="audio/audio.mp3" preload="auto" crossorigin="anonymous" loop></audio>
  <button id="audioToggleBtn" style="position: fixed; top: 20px; right: 20px; z-index: 100000; background: #ff6b81; color: white; border: none; padding: 10px 15px; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center;" title="Toggle Audio">üîä</button>
  
  <script>
    var audio = document.getElementById('audio');
    var audioBtn = document.getElementById('audioToggleBtn');
    var isPlaying = false;
    var hasTriedAutoplay = false;
    
    // Try local path first, fallback to GitHub raw if fails
    audio.src = 'audio/audio.mp3';
    audio.addEventListener('error', function(e) {
      console.error('Local audio failed:', e.target.error);
      if (this.src.indexOf('raw.githubusercontent.com') === -1) {
        console.log('Trying GitHub CDN...');
        this.src = 'https://raw.githubusercontent.com/Raiiynn/love-confession/main/audio/audio.mp3';
      }
    });
    
    function attemptAutoplay() {
      if (!hasTriedAutoplay) {
        hasTriedAutoplay = true;
        // Try to resume saved position
        try {
          var savedTime = sessionStorage.getItem('audio_currentTime');
          if (savedTime && audio.readyState >= 1) {
            try {
              audio.currentTime = Math.min(parseFloat(savedTime), audio.duration || parseFloat(savedTime));
            } catch (e) { }
          }
        } catch (e) {}
        
        audio.play().then(function() {
          console.log('Autoplay successful');
          isPlaying = true;
          audioBtn.textContent = 'üîä';
        }).catch(function(err) {
          console.log('Autoplay blocked:', err);
        });
      }
    }
    
    audioBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      if (isPlaying) {
        audio.pause();
        audioBtn.textContent = 'üîá';
        isPlaying = false;
      } else {
        audio.play().catch(function(err) {
          console.error('Play failed:', err);
        });
        audioBtn.textContent = 'üîä';
        isPlaying = true;
      }
    });
    
    audio.addEventListener('play', function() {
      console.log('Audio playing');
      isPlaying = true;
      audioBtn.textContent = 'üîä';
    });
    
    audio.addEventListener('pause', function() {
      console.log('Audio paused');
      isPlaying = false;
      audioBtn.textContent = 'üîá';
    });
    
    audio.addEventListener('loadstart', function() {
      console.log('Audio loading from:', this.src);
    });
    
    audio.addEventListener('canplay', function() {
      console.log('Audio ready to play');
      attemptAutoplay();
    });
    
    // Try autoplay on first user interaction (click, touch, key)
    document.addEventListener('click', attemptAutoplay, { once: true });
    document.addEventListener('touchstart', attemptAutoplay, { once: true });
    document.addEventListener('keydown', attemptAutoplay, { once: true });
    
    // keep updating saved position while on this page
    try {
      setInterval(function(){
        try {
          if (!isNaN(audio.currentTime)) {
            sessionStorage.setItem('audio_currentTime', audio.currentTime.toString());
            sessionStorage.setItem('audio_playing', (!audio.paused).toString());
          }
        } catch (e) {}
      }, 500);
    } catch (e) {}
  </script>

  <div class="ui-container">
    <div class="controls">
      <button class="control-btn active" id="colorBtn">Color Mode</button>
      <button class="control-btn" id="speedBtn">‚ö° Speed</button>
      <button class="control-btn" id="sizeBtn">üìè Size</button>
      <button class="control-btn" id="pauseBtn">‚è∏Ô∏è Pause</button>
      <button class="control-btn" id="resetBtn">üîÑ Reset</button>
      <button class="control-btn" id="nextBtn">Next ‚ñ∂Ô∏è</button>
    </div>
  </div>

  <div class="stats">
    <div>Particles: <span id="particleCount">0</span></div>
    <div>FPS: <span id="fps">60</span></div>
    <div>Mode: <span id="currentMode">Colorful</span></div>
  </div>

  <!-- Centered question and answer UI -->
  <div id="questionWrapper" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:12;text-align:center;pointer-events:auto">
    <div id="questionText" style="color:white;font-size:1.3rem;mix-blend-mode:screen;">Will you be my girl?</div>
  </div>

  <script src="./style/script.js">
    
  </script>
  <script>
    // Try to resume audio playback position saved by index.html
    (function(){
      var audio = document.getElementById('audio');
      if (!audio) return;
      try {
        var savedTime = sessionStorage.getItem('audio_currentTime');
        var wasPlaying = sessionStorage.getItem('audio_playing') === 'true';

        if (savedTime) {
          // wait until metadata is loaded to set currentTime
          audio.addEventListener('loadedmetadata', function() {
            try {
              audio.currentTime = Math.min(parseFloat(savedTime), audio.duration || parseFloat(savedTime));
            } catch (e) { }
            if (wasPlaying) {
              var p = audio.play();
              if (p && p.catch) p.catch(function(){});
            }
          });
          // in case metadata already loaded
          if (audio.readyState >= 1) {
            try {
              audio.currentTime = Math.min(parseFloat(savedTime), audio.duration || parseFloat(savedTime));
            } catch (e) { }
            if (wasPlaying) {
              var p2 = audio.play();
              if (p2 && p2.catch) p2.catch(function(){});
            }
          }
        } else if (wasPlaying) {
          // no saved time but wasPlaying true: try play
          var p3 = audio.play();
          if (p3 && p3.catch) p3.catch(function(){});
        }

        // keep updating saved position while on this page
        setInterval(function(){
          try {
            if (!isNaN(audio.currentTime)) {
              sessionStorage.setItem('audio_currentTime', audio.currentTime.toString());
              sessionStorage.setItem('audio_playing', (!audio.paused).toString());
            }
          } catch (e) {}
        }, 500);
      } catch (e) {}
    })();
  </script>
</body>
</html>
